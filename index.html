<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF QR Scanner</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Arial; margin: 0; padding: 0; }
      #message { background: white; max-width: 360px; margin: 100px auto 16px; padding: 32px 24px; border-radius: 3px; text-align: center;}
      #message h2 { color: #ffa100; font-weight: bold; font-size: 16px; margin: 0 0 8px; }
      #message h1 { font-size: 18px; font-weight: 300; color: rgba(0,0,0,0.6); margin: 0 0 16px; white-space: pre-line; }
    </style>
  </head>

  <body>

    <div id="message">
      <h2 id="head">Initializing...</h2>
      <h1 id="show"></h1>    
    </div>

    <script>

      // ------------------------------
      // Initialize LIFF
      // ------------------------------
      liff.init({ liffId: '2008561421-rBaENVkA' })
        .then(async () => {
          await liff.ready;   // <-- สำคัญมากสำหรับ iOS

          if (!liff.isInClient()) {
            document.getElementById('show').textContent = "กรุณาเปิดจากแอป LINE เท่านั้น";
            return;
          }

          document.getElementById('head').textContent = "Opening QR scanner...";
          scanQrCode();
        })
        .catch(err => {
          document.getElementById('show').textContent = "LIFF init error: " + err;
        });


      // ------------------------------
      // Scan QR Function
      // ------------------------------
      async function scanQrCode() {
        try {
          const result = await liff.scanCode();  
          const qrValue = result.value || "(no value)";

          const profile = await liff.getProfile();
          const myUid = profile.userId;

          const infoText = 
            "QR Value: " + qrValue + "\n" +
            "My UID: " + myUid;

          document.getElementById('show').textContent = infoText;

          // ส่งข้อความกลับไปยังแชท
          await liff.sendMessages([
            { type: 'text', text: "QR Value: " + qrValue },
            { type: 'text', text: "My UID: " + myUid }
          ]);

          document.getElementById('head').textContent = "Message sent!";
          setTimeout(() => liff.closeWindow(), 1000);

        } catch (err) {
          document.getElementById('show').textContent = "scanCode failed: " + err;
        }
      }

    </script>

  </body>
</html>
