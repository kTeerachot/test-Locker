<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF Scanner URL Scheme</title>
    <link rel="stylesheet" href="style.css">

    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
      /* Styles ‡πÄ‡∏î‡∏¥‡∏° */
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      #message { background: white; max-width: 360px; margin: 100px auto 16px; padding: 32px 24px; border-radius: 3px; text-align: center; }
      #message h2 { color: #ffa100; font-weight: bold; font-size: 16px; margin: 0 0 8px; }
      #show { white-space: pre-wrap; font-size: 14px; text-align: left; }
      #scanBtn { background:#039be5;color:#fff;border:none;padding:12px 18px;border-radius:6px;font-size:16px;cursor:pointer; }
      @media (max-width: 600px) {
        body, #message { margin-top: 0; background: white; box-shadow: none; }
        body { border-top: 16px solid #ffa100; }
      }
    </style>
  </head>
  <body>

    <div id="message">
      <h2 id="head">LIFF QR Scanner (Scheme)</h2>
      <div id="show">Loading LIFF...</div> 
      <div style="margin-top:18px;">
        <button id="scanBtn" disabled>Scan QR Code</button>
      </div>
    </div>

    <script>
      const LIFF_ID = '2008561421-rBaENVkA';
      const showElement = document.getElementById('show');
      const scanBtn = document.getElementById('scanBtn');
      let currentUID = '';

      // --- 1. FUNCTION TO SHOW UID AND QR RESULT ---
      async function updateDisplay(qrResult = null) {
        let info = "";
        try {
          // ‡∏î‡∏∂‡∏á UID
          const profile = await liff.getProfile();
          currentUID = profile.userId;

          info += "‚úÖ LIFF Ready\n";
          info += `üë§ Your UID: ${currentUID}\n`;
          info += `Platform: ${liff.getOS()} / LINE v${liff.getLineVersion()}`;

          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå QR ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
          if (qrResult) {
            info += `\n\nüîé QR Result: ${qrResult}`;
          }

        } catch (err) {
          info = 'Failed to get profile or init: ' + err.message;
          scanBtn.disabled = true;
        }
        showElement.textContent = info;
      }

      // --- 2. LIFF INITIALIZATION AND PARAMETER CHECK ---
      liff.init({ liffId: LIFF_ID })
        .then(async () => {
          scanBtn.disabled = false;
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Query Parameter ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏à‡∏≤‡∏Å LINE ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡πÅ‡∏Å‡∏ô QR
          const urlParams = new URLSearchParams(window.location.search);
          const scannedValue = urlParams.get('param');

          if (scannedValue) {
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô (param) ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            await updateDisplay(decodeURIComponent(scannedValue));
            
            // ‡∏•‡πâ‡∏≤‡∏á Query Parameter ‡πÉ‡∏ô URL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠ Refresh
            // (‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î URL ‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå LIFF)
            history.replaceState(null, null, window.location.pathname);
            
          } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà UID
            await updateDisplay();
          }
        })
        .catch(err => {
          showElement.textContent = 'LIFF init error: ' + err.message;
          console.error('liff.init error', err);
        });

      // --- 3. QR SCAN BUTTON HANDLER (Using URL Scheme) ---
      scanBtn.addEventListener('click', () => {
        if (!liff.isInClient()) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô LINE');
          return;
        }

        // URL Scheme ‡∏Ç‡∏≠‡∏á LINE ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô
        // redirectUri ‡∏Ñ‡∏∑‡∏≠ URL ‡∏Ç‡∏≠‡∏á LIFF ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ LINE ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        const currentUrl = window.location.href;
        const redirectUri = encodeURIComponent(currentUrl);
        const lineQrScheme = `https://line.me/R/NV/QRCodeReader?redirectUri=${redirectUri}`;

        // ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Redirect ‡πÑ‡∏õ‡∏¢‡∏±‡∏á URL Scheme
        window.location.href = lineQrScheme;
      });

    </script>

  </body>
</html>