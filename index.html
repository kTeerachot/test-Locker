<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <title>LIFF Starter</title>

    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      #message { background: white; max-width: 360px; margin: 100px auto 16px; padding: 32px 24px; border-radius: 3px; text-align: center;}
      #message h2 { color: #ffa100; font-weight: bold; font-size: 16px; margin: 0 0 8px; }
      #message h1 { font-size: 22px; font-weight: 300; color: rgba(0,0,0,0.6); margin: 0 0 16px; }
      #message p { line-height: 140%; margin: 16px 0 24px; font-size: 14px; }
      #message a { display: block; text-align: center; background: #039be5; text-transform: uppercase; text-decoration: none; color: white; padding: 16px; border-radius: 4px; }
      #message, #message a { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
      #load { color: rgba(0,0,0,0.4); text-align: center; font-size: 13px; }
      .error { color: #d32f2f; }
      @media (max-width: 600px) {
        body, #message { margin-top: 0; background: white; box-shadow: none; }
        body { border-top: 16px solid #ffa100; }
      }
    </style>
  </head>
  <body>

    <div id="message">
      <h2 id="head">กำลังเริ่มต้น...</h2>
      <h1 id="show"></h1>    
    </div>

    <script>
      // ใช้ async/await แทน callback เพื่อความเข้ากันได้กับ iOS
      async function initializeLiff() {
        try {
          document.getElementById('head').textContent = "กำลังเชื่อมต่อ LIFF...";
          
          // เริ่มต้น LIFF ด้วย Promise
          await liff.init({ liffId: '2008561421-rBaENVkA' });
          
          document.getElementById('head').textContent = "กำลังเปิดกล้อง...";
          
          // ตรวจสอบว่าอยู่ใน LINE Client หรือไม่
          if (!liff.isInClient()) {
            sendAlertIfNotInClient();
            return;
          }

          // ตรวจสอบว่า browser รองรับ scanCode หรือไม่
          if (!liff.scanCode) {
            document.getElementById('head').textContent = "ไม่รองรับการสแกน QR";
            document.getElementById('show').textContent = "อุปกรณ์นี้ไม่รองรับการสแกน QR Code";
            return;
          }

          // รอสักครู่ให้ LIFF พร้อมใช้งานอย่างสมบูรณ์ (สำคัญสำหรับ iOS)
          await new Promise(resolve => setTimeout(resolve, 300));

          // เรียกใช้ scanCode
          await scanQrCode();

        } catch (error) {
          console.error('LIFF Initialization failed', error);
          document.getElementById('head').textContent = "เกิดข้อผิดพลาด";
          document.getElementById('show').innerHTML = 
            '<span class="error">Error: ' + error.message + '</span>';
        }
      }

      /**
       * ฟังก์ชันสแกน QR Code
       */
      async function scanQrCode() {
        try {
          // เปิดกล้องสแกน QR
          const result = await liff.scanCode();
          
          // ค่า QR ที่สแกนได้
          const qrValue = result.value;
          
          // ดึงข้อมูล Profile
          const profile = await liff.getProfile();
          const myUid = profile.userId;
          
          // แสดงผลบนหน้าเว็บ
          const infoText = 
            "QR Value: " + qrValue + "\n" + 
            "My UID: " + myUid;
          
          document.getElementById('show').textContent = infoText;
          document.getElementById('head').textContent = "สแกนสำเร็จ!";
          
          // ส่งข้อความกลับไปยังแชท LINE
          await liff.sendMessages([
            {
              type: 'text',
              text: "QR Value: " + qrValue
            },
            {
              type: 'text',
              text: "My UID: " + myUid
            }
          ]);
          
          document.getElementById('head').textContent = "ส่งข้อความสำเร็จ!";
          
          // ปิดหน้าต่าง LIFF หลังจาก 1 วินาที
          setTimeout(() => {
            liff.closeWindow();
          }, 1000);
          
        } catch (error) {
          console.error('scanCode failed', error);
          
          // แสดง error message ที่เป็นมิตร
          let errorMsg = "ไม่สามารถสแกน QR Code ได้";
          
          if (error.code === 'UNAUTHORIZED') {
            errorMsg = "กรุณาอนุญาตให้เข้าถึงกล้อง";
          } else if (error.code === 'EXCEPTION') {
            errorMsg = "ผู้ใช้ยกเลิกการสแกน";
          }
          
          document.getElementById('head').textContent = "เกิดข้อผิดพลาด";
          document.getElementById('show').innerHTML = 
            '<span class="error">' + errorMsg + '<br><br>' + error.message + '</span>';
        }
      }

      /**
       * แจ้งเตือนเมื่อไม่ได้เปิดใน LINE
       */
      function sendAlertIfNotInClient() {
        document.getElementById('head').textContent = "ไม่สามารถใช้งานได้";
        document.getElementById('show').textContent = 
          "กรุณาเปิดผ่าน LINE App เท่านั้น";
      }

      // เริ่มต้นทำงานเมื่อโหลดหน้าเว็บเสร็จ
      window.addEventListener('DOMContentLoaded', () => {
        initializeLiff();
      });

    </script>

  </body>
</html>